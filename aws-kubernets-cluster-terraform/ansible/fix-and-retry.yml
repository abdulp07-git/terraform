---
- name: Fix Issues and Retry Kubernetes Setup
  hosts: all
  become: yes
  tasks:
    - name: Reset kubeadm (clean up failed init)
      shell: kubeadm reset -f
      ignore_errors: yes

    - name: Remove CNI config
      file:
        path: /etc/cni/net.d
        state: absent

    - name: Recreate CNI directory
      file:
        path: /etc/cni/net.d
        state: directory
        mode: '0755'

    - name: Set hostname properly
      hostname:
        name: "{{ inventory_hostname }}"

    - name: Add hostname to /etc/hosts
      lineinfile:
        path: /etc/hosts
        line: "{{ ansible_default_ipv4.address }} {{ inventory_hostname }}"
        state: present

    - name: Ensure localhost entries exist
      lineinfile:
        path: /etc/hosts
        line: "{{ item }}"
        state: present
      loop:
        - "127.0.0.1 localhost"
        - "127.0.1.1 {{ inventory_hostname }}"

    - name: Stop kubelet
      systemd:
        name: kubelet
        state: stopped
      ignore_errors: yes

    - name: Stop containerd
      systemd:
        name: containerd
        state: stopped

    - name: Remove containerd state
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /var/lib/containerd
        - /run/containerd

    - name: Recreate containerd directories
      file:
        path: "{{ item }}"
        state: directory
        mode: '0755'
      loop:
        - /var/lib/containerd
        - /run/containerd

    - name: Update containerd config with correct pause image
      lineinfile:
        path: /etc/containerd/config.toml
        regexp: '^\s*sandbox_image\s*='
        line: '    sandbox_image = "registry.k8s.io/pause:3.9"'
        insertafter: '^\[plugins."io.containerd.grpc.v1.cri"\]'

    - name: Restart containerd
      systemd:
        name: containerd
        state: restarted
        daemon_reload: yes

    - name: Wait for containerd to be ready
      wait_for:
        path: /run/containerd/containerd.sock
        state: present
        timeout: 60

    - name: Verify containerd is running
      shell: crictl --runtime-endpoint unix:///run/containerd/containerd.sock info
      register: containerd_status
      retries: 3
      delay: 5
      until: containerd_status.rc == 0

    - name: Enable and start kubelet
      systemd:
        name: kubelet
        enabled: yes
        state: started
        daemon_reload: yes

- name: Reinitialize Control Plane
  hosts: control_plane
  become: yes
  tasks:
    - name: Pull Kubernetes images
      shell: kubeadm config images pull
      retries: 3
      delay: 10

    - name: Initialize Kubernetes with verbose output
      shell: |
        kubeadm init \
          --pod-network-cidr=192.168.0.0/16 \
          --apiserver-advertise-address={{ ansible_default_ipv4.address }} \
          --node-name={{ inventory_hostname }} \
          --v=5
      register: kubeadm_init
      async: 600
      poll: 10

    - name: Display init output
      debug:
        msg: "{{ kubeadm_init.stdout_lines }}"

    - name: Create .kube directory for ubuntu user
      file:
        path: /home/ubuntu/.kube
        state: directory
        owner: ubuntu
        group: ubuntu
        mode: '0755'

    - name: Copy admin.conf to ubuntu user
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /home/ubuntu/.kube/config
        owner: ubuntu
        group: ubuntu
        mode: '0600'
        remote_src: yes

    - name: Create .kube directory for root
      file:
        path: /root/.kube
        state: directory
        mode: '0755'

    - name: Copy admin.conf to root
      copy:
        src: /etc/kubernetes/admin.conf
        dest: /root/.kube/config
        mode: '0600'
        remote_src: yes

    - name: Wait for API server
      wait_for:
        port: 6443
        delay: 10
        timeout: 300

    - name: Apply Calico CNI
      become_user: ubuntu
      shell: kubectl apply -f https://raw.githubusercontent.com/projectcalico/calico/v3.26.1/manifests/calico.yaml
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      retries: 3
      delay: 10

    - name: Wait for all pods to be ready
      become_user: ubuntu
      shell: kubectl wait --for=condition=Ready pods --all -n kube-system --timeout=600s
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      retries: 3
      delay: 30
      ignore_errors: yes

    - name: Generate join command
      shell: kubeadm token create --print-join-command
      register: join_command

    - name: Save join command locally
      local_action:
        module: copy
        content: "{{ join_command.stdout }}"
        dest: "./join-command.sh"
        mode: '0755'
      become: no

    - name: Display cluster status
      become_user: ubuntu
      shell: kubectl get nodes -o wide
      environment:
        KUBECONFIG: /home/ubuntu/.kube/config
      register: nodes_status

    - name: Show nodes
      debug:
        msg: "{{ nodes_status.stdout_lines }}"

- name: Join Worker Nodes
  hosts: worker_nodes
  become: yes
  tasks:
    - name: Copy join command
      copy:
        src: ./join-command.sh
        dest: /tmp/join-command.sh
        mode: '0755'

    - name: Join cluster
      shell: bash /tmp/join-command.sh
      register: join_result

    - name: Display join result
      debug:
        msg: "{{ join_result.stdout_lines }}"
